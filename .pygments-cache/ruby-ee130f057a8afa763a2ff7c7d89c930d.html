<div class="highlight"><pre><span class="k">class</span> <span class="nc">ApplicationMailer</span> <span class="o">&lt;</span> <span class="no">ActionMailer</span><span class="o">::</span><span class="no">Base</span>
  <span class="c1"># Call add_sendgrid_headers after generating each mail.</span>
  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">method_name</span><span class="o">=</span><span class="kp">nil</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">super</span><span class="o">.</span><span class="n">tap</span> <span class="k">do</span>
      <span class="n">add_sendgrid_headers</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="k">if</span> <span class="n">method_name</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="c1"># Set headers for SendGrid.</span>
  <span class="k">def</span> <span class="nf">add_sendgrid_headers</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="n">mailer</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">name</span>
    <span class="n">args</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">[</span> <span class="nb">method</span><span class="p">(</span><span class="n">action</span><span class="p">)</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:last</span><span class="p">)</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">]</span>
    <span class="n">headers</span> <span class="s2">&quot;X-SMTPAPI&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="n">category</span><span class="p">:</span>    <span class="o">[</span> <span class="n">mailer</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">mailer</span><span class="si">}</span><span class="s2">#</span><span class="si">#{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">,</span>
      <span class="n">unique_args</span><span class="p">:</span> <span class="p">{</span> <span class="n">environment</span><span class="p">:</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">inspect</span> <span class="p">}</span>
    <span class="p">}</span><span class="o">.</span><span class="n">to_json</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div>
