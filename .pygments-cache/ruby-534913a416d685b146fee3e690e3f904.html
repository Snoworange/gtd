<div class="highlight"><pre><span class="c1">#!/usr/bin/env ruby</span>
<span class="nb">require</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;TM_SUPPORT_PATH&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/lib/escape&quot;</span>

<span class="no">BUNDLE</span> <span class="o">=</span> <span class="s2">&quot;MyBundle&quot;</span>

<span class="no">GROWLNOTIFY</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/bin/growlnotify&quot;</span>
<span class="no">TM_SUPPORT_DIR</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/Library/Application Support/TextMate&quot;</span>
<span class="no">DIRTY</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">TM_SUPPORT_DIR</span><span class="si">}</span><span class="s2">/Bundles/</span><span class="si">#{</span><span class="no">BUNDLE</span><span class="si">}</span><span class="s2">.tmbundle/&quot;</span>
<span class="no">PRISTINE</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">TM_SUPPORT_DIR</span><span class="si">}</span><span class="s2">/Pristine Copy/Bundles/</span><span class="si">#{</span><span class="no">BUNDLE</span><span class="si">}</span><span class="s2">.tmbundle/&quot;</span>
<span class="no">LIMBO</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">TM_SUPPORT_DIR</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="no">BUNDLE</span><span class="si">}</span><span class="s2">.tmbundle/&quot;</span>

<span class="k">def</span> <span class="nf">writing_deltas?</span>
  <span class="ow">not</span> <span class="sb">`find </span><span class="si">#{</span><span class="n">e_sh</span> <span class="no">DIRTY</span><span class="si">}</span><span class="sb"> -regex &quot;.*\.tmDelta$&quot;`</span><span class="o">.</span><span class="n">empty?</span>
<span class="k">end</span>
<span class="k">def</span> <span class="nf">reload_bundles!</span>
  <span class="sb">`osascript -e &#39;tell app &quot;TextMate&quot; to reload bundles&#39;`</span>
<span class="k">end</span>
<span class="k">def</span> <span class="nf">mv</span><span class="p">(</span><span class="n">from</span><span class="p">,</span> <span class="n">to</span><span class="p">)</span>
  <span class="sb">`mv </span><span class="si">#{</span><span class="n">e_sh</span> <span class="n">from</span><span class="si">}</span><span class="sb"> </span><span class="si">#{</span><span class="n">e_sh</span> <span class="n">to</span><span class="si">}</span><span class="sb">`</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="n">from</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">reload_bundles!</span>  <span class="c1"># Reload before moving, so any pending changes are (I hope) written to the right place</span>
<span class="n">mv</span><span class="p">(</span><span class="no">DIRTY</span><span class="p">,</span> <span class="no">LIMBO</span><span class="p">);</span> <span class="n">mv</span><span class="p">(</span><span class="no">PRISTINE</span><span class="p">,</span> <span class="no">DIRTY</span><span class="p">);</span> <span class="n">mv</span><span class="p">(</span><span class="no">LIMBO</span><span class="p">,</span> <span class="no">PRISTINE</span><span class="p">)</span>
<span class="n">reload_bundles!</span>

<span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">BUNDLE</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">writing_deltas?</span> <span class="p">?</span> <span class="s2">&quot;Deltas&quot;</span> <span class="p">:</span> <span class="s2">&quot;Distribution&quot;</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="n">message</span> <span class="o">=</span> <span class="k">if</span> <span class="n">writing_deltas?</span>
  <span class="s2">&quot;Changes become deltas and are only available locally.&quot;</span>
<span class="k">else</span>
  <span class="s2">&quot;Changes are written directly to the distributed bundle; local changes are unavailable.&quot;</span>
<span class="k">end</span>

<span class="sb">`</span><span class="si">#{</span><span class="n">e_sh</span> <span class="no">GROWLNOTIFY</span><span class="si">}</span><span class="sb"> -s --icon=&quot;tmbundle&quot; -t </span><span class="si">#{</span><span class="n">e_sh</span> <span class="n">title</span><span class="si">}</span><span class="sb"> -m </span><span class="si">#{</span><span class="n">e_sh</span> <span class="n">message</span><span class="si">}</span><span class="sb">`</span>
</pre>
</div>
