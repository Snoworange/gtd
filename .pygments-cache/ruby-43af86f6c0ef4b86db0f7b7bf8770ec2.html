<div class="highlight"><pre><span class="n">excluded_setters</span>  <span class="o">=</span> <span class="sx">%w[id [] attributes]</span>
<span class="n">excluded_suffixes</span> <span class="o">=</span> <span class="sx">%w[count ids]</span>

<span class="n">usage</span> <span class="o">=</span> <span class="s2">&quot;Specify model like &#39;rake accessify MODEL=user&#39;.&quot;</span>

<span class="n">desc</span> <span class="s2">&quot;Outputs an attr_accessible statement with all setters except for those that typically are not for mass assigment, like *_count, *_ids and {created,updated}_{at,on}. </span><span class="si">#{</span><span class="n">usage</span><span class="si">}</span><span class="s2"> Note that this task is only meant to save the effort of typing in attributes manually; it does not make any security decisions for you. Read through the generated list of attributes very carefully and remove those that should not be available to mass assignment.&quot;</span>
<span class="n">task</span> <span class="ss">:accessify</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>

  <span class="k">begin</span>
    <span class="n">model</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;MODEL&#39;</span><span class="o">].</span><span class="n">downcase</span><span class="o">.</span><span class="n">classify</span><span class="o">.</span><span class="n">constantize</span>
  <span class="k">rescue</span>
    <span class="k">raise</span> <span class="s2">&quot;No such model! </span><span class="si">#{</span><span class="n">usage</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="k">end</span>

  <span class="nb">methods</span> <span class="o">=</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">instance_methods</span> <span class="o">-</span> <span class="no">Object</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">)</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">/=$/</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:chop</span><span class="p">)</span>
  <span class="n">columns</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">column_names</span>
  <span class="n">setters</span> <span class="o">=</span> <span class="nb">methods</span> <span class="o">|</span> <span class="n">columns</span>
  <span class="n">setters</span><span class="o">.</span><span class="n">reject!</span> <span class="k">do</span> <span class="o">|</span><span class="n">setter</span><span class="o">|</span>
    <span class="n">setter</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/_</span><span class="si">#{</span> <span class="no">Regexp</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="o">*</span><span class="n">excluded_suffixes</span><span class="p">)</span> <span class="si">}</span><span class="sr">$/</span><span class="p">)</span> <span class="o">||</span>
    <span class="n">setter</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/(created|updated)_(at|on)/</span><span class="p">)</span> <span class="o">||</span>
    <span class="n">excluded_setters</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">setter</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="n">setters</span> <span class="o">=</span> <span class="n">setters</span><span class="o">.</span><span class="n">sort</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:to_sym</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:inspect</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span>
  <span class="nb">puts</span> <span class="s2">&quot;attr_accessible </span><span class="si">#{</span> <span class="n">setters</span> <span class="si">}</span><span class="s2">&quot;</span>

<span class="k">end</span>
</pre>
</div>
