<div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$cache</span> <span class="o">=</span> <span class="s2">&quot;sinfest_feed.txt&quot;</span><span class="p">;</span>
<span class="nv">$expires</span> <span class="o">=</span> <span class="mi">30</span><span class="o">*</span><span class="mi">60</span><span class="p">;</span>  <span class="c1">// in 30 minutes</span>

<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">@</span><span class="nb">filemtime</span><span class="p">(</span><span class="nv">$cache</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">time</span><span class="p">()</span> <span class="o">-</span> <span class="nv">$expires</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// Cache expired, or does not exist</span>

  <span class="nv">$feed</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="s2">&quot;http://www.sinfest.net/rss.php&quot;</span><span class="p">);</span>
  <span class="nv">$feed</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">&#39;!(\s*)&lt;link&gt;(.+?\.(?:gif|png|jpe?g))&lt;/link&gt;!&#39;</span><span class="p">,</span> <span class="s1">&#39;$0$1&lt;description&gt;&amp;lt;img src=&quot;$2&quot; alt=&quot;Comic&quot;&amp;gt;&lt;/description&gt;&#39;</span><span class="p">,</span> <span class="nv">$feed</span><span class="p">);</span>
  <span class="nv">$feed</span> <span class="o">=</span> <span class="nb">preg_replace</span><span class="p">(</span><span class="s1">&#39;/^\s*/&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="nv">$feed</span><span class="p">);</span>  <span class="c1">// Source feed has illegal initial whitespace</span>

  <span class="nv">$c</span> <span class="o">=</span> <span class="nb">fopen</span><span class="p">(</span><span class="nv">$cache</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">);</span>
  <span class="nb">fwrite</span><span class="p">(</span><span class="nv">$c</span><span class="p">,</span> <span class="nv">$feed</span><span class="p">);</span>
  <span class="nb">fclose</span><span class="p">(</span><span class="nv">$c</span><span class="p">);</span>

<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="c1">// Was cached, so retrieve</span>

  <span class="nv">$feed</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$cache</span><span class="p">);</span>

<span class="p">}</span>

<span class="nx">header</span><span class="p">(</span><span class="s1">&#39;Content-type: application/rss+xml&#39;</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$feed</span><span class="p">;</span>

<span class="cp">?&gt;</span><span class="x"></span>
</pre>
</div>
