<div class="highlight"><pre><span class="c1"># By Henrik Nyh &lt;http://henrik.nyh.se&gt; 2007-06-27</span>
<span class="c1"># Free to modify and redistribute with credit.</span>

<span class="k">class</span> <span class="nc">Preferences</span>
  <span class="sx">%w{yaml fileutils}</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">lib</span><span class="o">|</span> <span class="nb">require</span> <span class="n">lib</span> <span class="p">}</span>

  <span class="c1"># Each preference id should be a singleton</span>

  <span class="vc">@@instances</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span><span class="p">;</span> <span class="kp">private</span> <span class="ss">:new</span><span class="p">;</span> <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">[]</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="k">raise</span><span class="p">(</span><span class="no">ArgumentError</span><span class="p">,</span> <span class="s2">&quot;Preference id must match /\A[a-zA-Z0-9_]+\Z/.&quot;</span><span class="p">)</span> <span class="k">unless</span> <span class="nb">id</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/\A\w+\Z/</span>
    <span class="vc">@@instances</span><span class="o">[</span><span class="nb">id</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">||=</span> <span class="kp">new</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
    <span class="vi">@id</span> <span class="o">=</span> <span class="nb">id</span><span class="o">.</span><span class="n">to_s</span>
  <span class="k">end</span>

  <span class="c1"># Singleton code ends</span>

  <span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">to_hash</span><span class="o">[</span><span class="n">key</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">[]=</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">merge!</span><span class="p">({</span><span class="n">key</span> <span class="o">=&gt;</span> <span class="n">value</span><span class="p">})</span>
    <span class="n">value</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">merge!</span><span class="p">(</span><span class="n">new_hash</span><span class="p">)</span>
    <span class="n">symbolized_keys</span> <span class="o">=</span> <span class="n">new_hash</span><span class="o">.</span><span class="n">inject</span><span class="p">({})</span> <span class="p">{</span> <span class="o">|</span><span class="n">h</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="o">|</span> <span class="n">h</span><span class="o">[</span><span class="n">k</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span> <span class="n">h</span> <span class="p">}</span>
    <span class="vi">@hash</span> <span class="o">=</span> <span class="n">to_hash</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">symbolized_keys</span><span class="p">)</span>
    <span class="n">persist!</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">to_sym</span>
    <span class="n">value</span> <span class="o">=</span> <span class="nb">self</span><span class="o">[</span><span class="n">key</span><span class="o">]</span>
    <span class="vi">@hash</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="n">persist!</span>
    <span class="n">value</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">clear!</span>
    <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">flush_cache!</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">flush_cache!</span>
    <span class="vi">@hash</span> <span class="o">=</span> <span class="kp">nil</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">to_hash</span>
    <span class="vi">@hash</span> <span class="o">||=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">rescue</span> <span class="p">{}</span>
  <span class="k">end</span>

<span class="kp">private</span>

  <span class="k">def</span> <span class="nf">path</span>
    <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/Library/Preferences/com.macromates.textmate.</span><span class="si">#{</span><span class="vi">@id</span><span class="si">}</span><span class="s2">.yaml&quot;</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">persist!</span>
    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">out</span><span class="o">|</span> <span class="no">YAML</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="vi">@hash</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span> <span class="p">}</span>
    <span class="vi">@hash</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
</div>
