<div class="highlight"><pre><span class="kd">function</span> <span class="nx">$</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span> <span class="p">}</span>
<span class="kd">function</span> <span class="nx">destroy</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span> <span class="nx">el</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">removeChild</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span> <span class="p">}</span>

<span class="kd">function</span> <span class="nx">get_source_for</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;head&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">].</span><span class="nx">appendChild</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;script&quot;</span><span class="p">));</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s2">&quot;fbat_request_&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
  <span class="nx">request</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;http://api.flickr.com/services/rest/?method=flickr.photos.getSizes&amp;format=json&amp;api_key=58b74bb27f70254a67c34ed95710bc12&amp;photo_id=&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;fbat_&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">jsonFlickrApi</span><span class="p">(</span><span class="nx">json</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">counter</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">json</span><span class="p">[</span><span class="s2">&quot;stat&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;fail&quot;</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">source</span><span class="p">,</span> <span class="nx">sizes</span> <span class="o">=</span> <span class="nx">json</span><span class="p">[</span><span class="s2">&quot;sizes&quot;</span><span class="p">][</span><span class="s2">&quot;size&quot;</span><span class="p">];</span>
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">sizes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">source</span> <span class="o">=</span> <span class="nx">sizes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">sizes</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s2">&quot;label&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;Original&quot;</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">source</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\/(\d+)_/</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

  <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;fbat_&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="nx">destroy</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;fbat_request_&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">));</span>

  <span class="nx">results</span><span class="p">[</span><span class="nx">id</span><span class="p">][</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">source</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">counter</span><span class="p">)</span> <span class="nx">finish</span><span class="p">();</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">finish</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">images</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">ordered_keys</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">image</span> <span class="o">=</span> <span class="nx">results</span><span class="p">[</span><span class="nx">ordered_keys</span><span class="p">[</span><span class="nx">i</span><span class="p">]];</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">image</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">format</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^b/i</span><span class="p">))</span>  <span class="c1">// b, BB, BBcode, ...</span>
      <span class="nx">images</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;[img]&#39;</span> <span class="o">+</span> <span class="nx">image</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;[/img]&#39;</span><span class="p">);</span>
    <span class="k">else</span>
      <span class="nx">images</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;&lt;a href=&quot;&#39;</span> <span class="o">+</span> <span class="nx">image</span><span class="p">[</span><span class="s2">&quot;href&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot; title=&quot;&#39;</span> <span class="o">+</span> <span class="nx">image</span><span class="p">[</span><span class="s2">&quot;alt&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot;&gt;&lt;img src=&quot;&#39;</span> <span class="o">+</span> <span class="nx">image</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;&quot; alt=&quot;&#39;</span><span class="o">+</span> <span class="nx">image</span><span class="p">[</span><span class="s2">&quot;alt&quot;</span><span class="p">]</span> <span class="o">+</span><span class="s1">&#39;&quot; /&gt;&lt;/a&gt;&#39;</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">var</span> <span class="nx">output</span><span class="p">,</span> <span class="nx">output_prefix</span><span class="p">,</span> <span class="nx">output_suffix</span><span class="p">;</span>
  <span class="nx">output_prefix</span> <span class="o">=</span> <span class="nx">output_suffix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">format</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^l/i</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// l, LJ, LJcut, ...</span>
    <span class="nx">output_prefix</span> <span class="o">=</span> <span class="s2">&quot;&lt;lj-cut text=\&quot;The photos.\&quot;&gt;\n\n&quot;</span><span class="p">;</span>
    <span class="nx">output_suffix</span> <span class="o">=</span> <span class="s2">&quot;\n\n&lt;/lj-cut&gt;&quot;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nx">output</span> <span class="o">=</span> <span class="nx">output_prefix</span> <span class="o">+</span> <span class="nx">images</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="s2">&quot;\n\n&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">output_suffix</span><span class="p">;</span>

  <span class="nx">present</span><span class="p">(</span><span class="nx">output</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">present</span><span class="p">(</span><span class="nx">output</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">overlay</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">);</span>
  <span class="kd">with</span> <span class="p">(</span><span class="nx">overlay</span><span class="p">.</span><span class="nx">style</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">position</span> <span class="o">=</span> <span class="s1">&#39;fixed&#39;</span><span class="p">;</span>
    <span class="nx">top</span> <span class="o">=</span> <span class="nx">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nx">width</span> <span class="o">=</span> <span class="nx">height</span> <span class="o">=</span> <span class="s1">&#39;100%&#39;</span><span class="p">;</span>
    <span class="nx">textAlign</span> <span class="o">=</span> <span class="s1">&#39;center&#39;</span><span class="p">;</span>
    <span class="nx">backgroundColor</span> <span class="o">=</span> <span class="s1">&#39;#FFF&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">overlay</span><span class="p">);</span>
  <span class="nx">overlay</span><span class="p">.</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="s2">&quot;&lt;h3&gt;Copy this code, then click without the box to discard.&lt;/h3&gt;&lt;textarea style=&#39;width:90%;height:80%;border:1px solid #000;background:#FEFEFE;padding:1em;&#39; id=&#39;fbat_output&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">output</span> <span class="o">+</span> <span class="s2">&quot;&lt;/textarea&gt;&quot;</span><span class="p">;</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;fbat_output&#39;</span><span class="p">).</span><span class="nx">select</span><span class="p">();</span>
  <span class="nx">content</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">destroy</span><span class="p">(</span><span class="nx">overlay</span><span class="p">);</span> <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;fbat_output&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="nx">e</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span> <span class="p">},</span> <span class="kc">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ordered_keys</span> <span class="o">=</span> <span class="p">[],</span> <span class="nx">results</span> <span class="o">=</span> <span class="p">{};</span>
<span class="kd">var</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">image</span><span class="p">,</span> <span class="nx">images</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">images</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">format</span> <span class="o">=</span> <span class="s2">&quot;%s&quot;</span><span class="p">;</span>

<span class="k">for</span> <span class="p">(</span><span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">images</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">image</span> <span class="o">=</span> <span class="nx">images</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
  <span class="k">if</span> <span class="p">(</span>
    <span class="p">(</span><span class="nx">m</span> <span class="o">=</span> <span class="nx">image</span><span class="p">.</span><span class="nx">src</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/http:\/\/.*?static\.flickr\.com\/\d+\/(\d+)_[a-z\d]+(?:_[a-z])?\.jpg/</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
    <span class="o">!</span><span class="nx">image</span><span class="p">.</span><span class="nx">className</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\b(setThumb|nextprev_thumb)\b/</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
    <span class="nx">image</span><span class="p">.</span><span class="nx">id</span> <span class="o">!=</span> <span class="s2">&quot;primary_photo_img&quot;</span>
  <span class="p">)</span> <span class="p">{</span>
    <span class="nx">id</span> <span class="o">=</span> <span class="nx">m</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="nx">image</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="s2">&quot;fbat_&quot;</span> <span class="o">+</span> <span class="nx">id</span><span class="p">;</span>
    <span class="nx">ordered_keys</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="nx">results</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;alt&quot;</span> <span class="o">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">alt</span><span class="p">,</span> <span class="s2">&quot;href&quot;</span> <span class="o">:</span> <span class="nx">image</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">href</span><span class="p">};</span>
    <span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="nx">get_source_for</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">void</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</pre>
</div>
