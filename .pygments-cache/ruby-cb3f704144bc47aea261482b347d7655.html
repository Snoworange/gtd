<div class="highlight"><pre><span class="c1"># LEXML by Henrik Nyh &lt;http://henrik.nyh.se&gt; 2006-07-24</span>
<span class="c1"># Free to modify, but please credit.</span>
<span class="c1">#</span>
<span class="c1"># Very simple wrapper that uses the fast libxml</span>
<span class="c1"># &lt;http://libxml.rubyforge.org/&gt; if available, otherwise the slower</span>
<span class="c1"># but bundled-with-Ruby-1.8+ REXML</span>
<span class="c1"># &lt;http://www.ruby-doc.org/stdlib/libdoc/rexml/rdoc/&gt;. Handles the</span>
<span class="c1"># very basics of reading XML data.</span>

<span class="k">class</span> <span class="nc">LEXML</span>

  <span class="k">begin</span>
    <span class="nb">require</span> <span class="s2">&quot;rubygems&quot;</span>
    <span class="nb">require</span> <span class="s2">&quot;xml/libxml&quot;</span>
    <span class="no">GOT_LIBXML</span> <span class="o">=</span> <span class="kp">true</span>
    <span class="no">XML</span><span class="o">::</span><span class="no">Parser</span><span class="o">.</span><span class="n">default_warnings</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">rescue</span> <span class="no">LoadError</span>  <span class="c1"># Fall back to REXML</span>
    <span class="nb">require</span> <span class="s2">&quot;rexml/document&quot;</span>
    <span class="no">GOT_LIBXML</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">libxml?</span>
    <span class="c1"># e.g:</span>
    <span class="c1"># puts LEXML::libxml? ? &quot;Using libxml&quot; : &quot;Using REXML&quot;</span>
    <span class="no">GOT_LIBXML</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="c1"># e.g:</span>
    <span class="c1"># xml = LEXML.new(&quot;file.xml&quot;)</span>
    <span class="k">if</span> <span class="no">LEXML</span><span class="o">::</span><span class="n">libxml?</span>
      <span class="vi">@handle</span> <span class="o">=</span> <span class="no">XML</span><span class="o">::</span><span class="no">Document</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">else</span>  <span class="c1"># Fall back to REXML</span>
      <span class="vi">@handle</span> <span class="o">=</span> <span class="no">REXML</span><span class="o">::</span><span class="no">Document</span><span class="o">.</span><span class="n">new</span> <span class="no">File</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">root</span>
    <span class="no">Node</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@handle</span><span class="o">.</span><span class="n">root</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Nodeset</span> <span class="o">&lt;</span> <span class="nb">Array</span>
  <span class="k">end</span>

  <span class="k">class</span> <span class="nc">Node</span> <span class="o">&lt;</span> <span class="nb">String</span>
    <span class="c1"># For a node &lt;dog size=&quot;small&quot; cute=&quot;true&quot;&gt;pug&lt;/dog&gt;:</span>
    <span class="c1">#   node =&gt; &quot;pug&quot;</span>
    <span class="c1">#   node[:size] =&gt; &quot;small&quot;; node[&quot;size&quot;] =&gt; &quot;small&quot;</span>
    <span class="c1">#   size, cute = node[:size, :cute]</span>
    <span class="c1"># For a node &lt;animals&gt;&lt;dogs&gt;&lt;dog&gt;Fabulous&lt;/dog&gt;&lt;dog&gt;Spanko&lt;/dog&gt;&lt;/dogs&gt;:</span>
    <span class="c1">#   node.child(&quot;dogs&quot;) =&gt; the dogs node</span>
    <span class="c1">#   node.children(&quot;dogs/dog&quot;) =&gt; both dog nodes</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="vi">@node</span> <span class="o">=</span> <span class="n">node</span>
      <span class="k">super</span><span class="p">((</span><span class="no">LEXML</span><span class="o">::</span><span class="n">libxml?</span> <span class="p">?</span> <span class="vi">@node</span><span class="o">.</span><span class="n">content</span> <span class="p">:</span> <span class="vi">@node</span><span class="o">.</span><span class="n">text</span><span class="p">)</span> <span class="o">||</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="o">*</span><span class="n">attributes</span><span class="p">)</span>
      <span class="n">list</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">attribute</span><span class="o">|</span> <span class="no">LEXML</span><span class="o">::</span><span class="n">libxml?</span> <span class="p">?</span> <span class="vi">@node</span><span class="o">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span> <span class="p">:</span> <span class="vi">@node</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="n">attribute</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span>  <span class="p">}</span>
      <span class="n">list</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">list</span><span class="o">.</span><span class="n">first</span> <span class="p">:</span> <span class="n">list</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">children</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
      <span class="k">if</span> <span class="no">LEXML</span><span class="o">::</span><span class="n">libxml?</span>
        <span class="no">LEXML</span><span class="o">::</span><span class="no">Nodeset</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@node</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">type</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="no">Node</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
      <span class="k">else</span>
        <span class="n">kids</span> <span class="o">=</span> <span class="o">[]</span>
        <span class="vi">@node</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="n">type</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">kids</span> <span class="o">&lt;&lt;</span> <span class="no">Node</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>
        <span class="no">LEXML</span><span class="o">::</span><span class="no">Nodeset</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">kids</span><span class="p">)</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">def</span> <span class="nf">child</span><span class="p">(</span><span class="n">type</span><span class="p">)</span>
      <span class="n">children</span><span class="p">(</span><span class="n">type</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
</div>
