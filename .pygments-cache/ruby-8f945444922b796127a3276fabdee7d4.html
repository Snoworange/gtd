<div class="highlight"><pre><span class="sx">%w{cgi iconv rexml/document}</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">lib</span><span class="o">|</span> <span class="nb">require</span> <span class="n">lib</span> <span class="p">}</span>

<span class="k">unless</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="no">STDERR</span><span class="o">.</span><span class="n">puts</span> <span class="sx">%{Usage: ruby &quot;</span><span class="si">#{</span><span class="vg">$0</span><span class="si">}</span><span class="sx">&quot; &quot;/Some/Dir/SharePod_iTunes_Import.xml&quot;}</span>
    <span class="nb">exit</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s2">&quot;Processing...&quot;</span>
<span class="n">doc</span> <span class="o">=</span> <span class="no">REXML</span><span class="o">::</span><span class="no">Document</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGF</span><span class="p">)</span>

<span class="c1"># Loop over location strings, recoding them from encoded Latin-1 to encoded UTF-8</span>
<span class="n">doc</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="s1">&#39;//key[.=&quot;Location&quot;]/following-sibling::string&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span>
    <span class="n">source</span> <span class="o">=</span> <span class="no">CGI</span><span class="o">.</span><span class="n">unescape</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>  <span class="c1"># Unescape into Latin-1</span>
    <span class="n">recoded_source</span> <span class="o">=</span> <span class="no">CGI</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="no">Iconv</span><span class="o">.</span><span class="n">iconv</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span> <span class="s1">&#39;latin1&#39;</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">)</span>  <span class="c1"># Convert to UTF-8 and re-escape</span>
    <span class="n">node</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">recoded_source</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">,</span> <span class="s1">&#39;%20&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;%2F&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;file%3A//&#39;</span><span class="p">,</span> <span class="s1">&#39;file://&#39;</span><span class="p">)</span>  <span class="c1"># Fix stuff iTunes would choke on</span>
<span class="k">end</span>

<span class="n">output_file</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">sub</span><span class="p">(</span><span class="sr">/(\.xml)?$/i</span><span class="p">,</span> <span class="s1">&#39;_fixed.xml&#39;</span><span class="p">)</span>
<span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">print</span> <span class="n">doc</span> <span class="p">}</span>

<span class="nb">puts</span> <span class="s2">&quot;Done.&quot;</span>
</pre>
</div>
