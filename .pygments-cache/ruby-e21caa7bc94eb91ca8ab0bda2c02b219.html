<div class="highlight"><pre><span class="c1"># Make Time.now do Central European Time</span>
<span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;TZ&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;CET&#39;</span>

<span class="sx">%w{rubygems hpricot open-uri rexml/document time}</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">lib</span><span class="o">|</span> <span class="nb">require</span> <span class="n">lib</span> <span class="p">}</span>

<span class="k">class</span> <span class="nc">LiveJournal</span>
  <span class="no">USER_AGENT</span> <span class="o">=</span> <span class="s2">&quot;http://mysite.example.com; me@mysite.example.com&quot;</span>
  <span class="no">STALE_IN_MINUTES</span> <span class="o">=</span> <span class="mi">3</span>
  <span class="no">CACHE_FILE</span> <span class="o">=</span> <span class="s2">&quot;lj-cache.txt&quot;</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">username</span><span class="p">)</span>
    <span class="vi">@username</span> <span class="o">=</span> <span class="n">username</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">recent_entries</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="ss">:max</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">})</span>
    <span class="n">age</span> <span class="o">=</span> <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="no">CACHE_FILE</span><span class="p">)</span> <span class="k">then</span> <span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="no">File</span><span class="o">.</span><span class="n">mtime</span><span class="p">(</span><span class="no">CACHE_FILE</span><span class="p">))</span><span class="o">/</span><span class="mi">60</span> <span class="k">else</span> <span class="no">STALE_IN_MINUTES</span> <span class="k">end</span>
    <span class="n">retrieve</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">unless</span> <span class="n">age</span> <span class="o">&lt;</span> <span class="no">STALE_IN_MINUTES</span>
    <span class="n">entries</span> <span class="o">=</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">CACHE_FILE</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">entries</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">options</span><span class="o">[</span><span class="ss">:max</span><span class="o">]</span>
      <span class="n">retrieve</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">entries</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>

  <span class="k">def</span> <span class="nf">blog</span><span class="p">()</span> <span class="s2">&quot;http://</span><span class="si">#{</span><span class="vi">@username</span><span class="si">}</span><span class="s2">.livejournal.com/&quot;</span> <span class="k">end</span>
  <span class="k">def</span> <span class="nf">feed</span><span class="p">()</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">blog</span><span class="si">}</span><span class="s2">data/rss&quot;</span> <span class="k">end</span>

  <span class="c1"># By the rules in http://www.livejournal.com/bots/.</span>
  <span class="k">def</span> <span class="nf">friendly_open</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="nb">open</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;User-Agent&quot;</span> <span class="o">=&gt;</span> <span class="no">USER_AGENT</span><span class="p">})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">retrieve</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
    <span class="c1"># Get the abbreviated (LJ-cut) bodies</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="no">Hpricot</span><span class="p">(</span><span class="n">friendly_open</span><span class="p">(</span><span class="n">blog</span><span class="p">))</span>
    <span class="n">bodies</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sx">%{//table[@class=&quot;entrybox&quot;]/tr/td/table/tr[2]/td}</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span> <span class="n">entry</span><span class="o">.</span><span class="n">inner_html</span><span class="o">.</span><span class="n">strip</span> <span class="p">}</span>
    <span class="n">comment_counts</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sx">%{//table[@class=&quot;entrybox&quot;]//td[@class=&quot;comments&quot;][1]}</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">td</span><span class="o">|</span> <span class="n">td</span><span class="o">.</span><span class="n">inner_text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\d+/</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">to_i</span> <span class="p">}</span>

    <span class="c1"># Get metadata and create post representations</span>
    <span class="n">posts</span> <span class="o">=</span> <span class="o">[]</span>
    <span class="n">xml</span> <span class="o">=</span> <span class="no">REXML</span><span class="o">::</span><span class="no">Document</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">friendly_open</span><span class="p">(</span><span class="n">feed</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">)</span>
    <span class="n">xml</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">to_a</span><span class="p">(</span><span class="s2">&quot;channel/item&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">item</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
      <span class="k">break</span> <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="n">bodies</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span> <span class="n">options</span><span class="o">[</span><span class="ss">:max</span><span class="o">]</span> <span class="o">==</span> <span class="n">index</span>
      <span class="n">posts</span> <span class="o">&lt;&lt;</span> <span class="p">{</span>
        <span class="ss">:link</span> <span class="o">=&gt;</span> <span class="n">item</span><span class="o">.</span><span class="n">elements</span><span class="o">[</span><span class="s2">&quot;link&quot;</span><span class="o">].</span><span class="n">text</span><span class="p">,</span>
        <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">elements</span><span class="o">[</span><span class="s2">&quot;title&quot;</span><span class="o">].</span><span class="n">text</span> <span class="k">rescue</span> <span class="kp">nil</span><span class="p">),</span>
        <span class="ss">:date</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">elements</span><span class="o">[</span><span class="s2">&quot;pubDate&quot;</span><span class="o">].</span><span class="n">text</span><span class="p">),</span>
        <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">bodies</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="p">,</span>
        <span class="ss">:comment_link</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">elements</span><span class="o">[</span><span class="s2">&quot;comments&quot;</span><span class="o">].</span><span class="n">text</span> <span class="k">rescue</span> <span class="kp">nil</span><span class="p">),</span>
        <span class="ss">:comment_count</span> <span class="o">=&gt;</span> <span class="n">comment_counts</span><span class="o">[</span><span class="n">index</span><span class="o">]</span>
      <span class="p">}</span>
    <span class="k">end</span>

    <span class="c1"># Write to cache</span>
    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="no">CACHE_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">print</span> <span class="no">Marshal</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">posts</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">posts</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
</div>
