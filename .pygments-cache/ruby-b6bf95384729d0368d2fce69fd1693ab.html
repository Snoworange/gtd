<div class="highlight"><pre><span class="c1">#!/usr/bin/env ruby</span>

<span class="c1"># This script generates a RSS feed for The Dilbert Blog with full entries,</span>
<span class="c1"># as opposed to summaries.</span>

<span class="c1"># Enable using gems I&#39;ve installed, on Dreamhost</span>
<span class="c1"># http://nateclark.com/articles/2006/10/20/dreamhost-your-own-packages-and-gems</span>
<span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;GEM_PATH&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;/usr/lib/ruby/gems/1.8:/home/henrik/.gems&quot;</span>

<span class="nb">require</span> <span class="s2">&quot;rubygems&quot;</span>
<span class="nb">require</span> <span class="s2">&quot;feedalizer&quot;</span>

<span class="no">URL</span>   <span class="o">=</span> <span class="s2">&quot;http://dilbertblog.typepad.com/the_dilbert_blog/&quot;</span>
<span class="no">CACHE_FILE</span> <span class="o">=</span> <span class="s2">&quot;dilbert.cache&quot;</span>
<span class="no">CACHE_LIFE</span>  <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># minutes</span>

<span class="k">def</span> <span class="nf">uncached?</span>
  <span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">exist?</span><span class="p">(</span><span class="no">CACHE_FILE</span><span class="p">)</span> <span class="o">||</span>
  <span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="no">File</span><span class="o">.</span><span class="n">mtime</span><span class="p">(</span><span class="no">CACHE_FILE</span><span class="p">))</span><span class="o">/</span><span class="mi">60</span> <span class="o">&gt;</span> <span class="no">CACHE_LIFE</span>
<span class="k">end</span>

<span class="nb">print</span> <span class="s2">&quot;Content-Type: text/xml</span><span class="se">\n\n</span><span class="s2">&quot;</span>

<span class="n">feedalize</span><span class="p">(</span><span class="no">URL</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">feed</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;The Dilbert Blog: Full Entries&quot;</span>
  <span class="n">feed</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Dilbert humor, business absurdity, the meaning of life. And full entries.&quot;</span>
  <span class="n">feed</span><span class="o">.</span><span class="n">about</span> <span class="o">=</span> <span class="no">URL</span>

  <span class="n">scrape_items</span><span class="p">(</span><span class="s2">&quot;//div.entry&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">rss_item</span><span class="p">,</span> <span class="n">html_entry</span><span class="o">|</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">html_entry</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;.entry-header&#39;</span><span class="p">)</span>
    <span class="n">rss_item</span><span class="o">.</span><span class="n">link</span>  <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attributes</span><span class="o">[</span><span class="s1">&#39;href&#39;</span><span class="o">]</span>
    <span class="n">rss_item</span><span class="o">.</span><span class="n">date</span>  <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">html_entry</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;.post-footers&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">inner_text</span><span class="p">)</span>
    <span class="n">rss_item</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">header</span><span class="o">.</span><span class="n">inner_text</span>
    <span class="n">rss_item</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">html_entry</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="s1">&#39;.entry-body&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">inner_html</span>
  <span class="k">end</span>

  <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="no">CACHE_FILE</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="n">output</span> <span class="p">}</span>  <span class="c1"># cache output</span>
<span class="k">end</span> <span class="k">if</span> <span class="n">uncached?</span>

<span class="nb">print</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">CACHE_FILE</span><span class="p">)</span>
</pre>
</div>
