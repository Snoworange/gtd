<div class="highlight"><pre><span class="n">namespace</span> <span class="ss">:solr</span> <span class="k">do</span>

  <span class="n">desc</span> <span class="sx">%{Reindexes data for all acts_as_solr models. Clears index first to get rid of orphaned records and optimizes index afterwards. RAILS_ENV=your_env to set environment. ONLY=book,person,magazine to only reindex those models; EXCEPT=book,magazine to exclude those models. START_SERVER=true to solr:start before and solr:stop after. BATCH=123 to post/commit in batches of that size: default is 300. CLEAR=false to not clear the index first; OPTIMIZE=false to not optimize the index afterwards.}</span>
  <span class="n">task</span> <span class="ss">:reindex</span> <span class="o">=&gt;</span> <span class="ss">:environment</span> <span class="k">do</span>

    <span class="n">includes</span> <span class="o">=</span> <span class="n">env_array_to_constants</span><span class="p">(</span><span class="s1">&#39;ONLY&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">includes</span><span class="o">.</span><span class="n">empty?</span>
      <span class="n">includes</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">RAILS_ROOT</span><span class="si">}</span><span class="s2">/app/models/*.rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span> <span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;.rb&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">camelize</span><span class="o">.</span><span class="n">constantize</span> <span class="p">}</span>
    <span class="k">end</span>
    <span class="n">excludes</span> <span class="o">=</span> <span class="n">env_array_to_constants</span><span class="p">(</span><span class="s1">&#39;EXCEPT&#39;</span><span class="p">)</span>
    <span class="n">includes</span> <span class="o">-=</span> <span class="n">excludes</span>

    <span class="n">optimize</span>     <span class="o">=</span> <span class="n">env_to_bool</span><span class="p">(</span><span class="s1">&#39;OPTIMIZE&#39;</span><span class="p">,</span>     <span class="kp">true</span><span class="p">)</span>
    <span class="n">start_server</span> <span class="o">=</span> <span class="n">env_to_bool</span><span class="p">(</span><span class="s1">&#39;START_SERVER&#39;</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span>
    <span class="n">clear_first</span>   <span class="o">=</span> <span class="n">env_to_bool</span><span class="p">(</span><span class="s1">&#39;CLEAR&#39;</span><span class="p">,</span>       <span class="kp">true</span><span class="p">)</span>
    <span class="n">batch_size</span>   <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;BATCH&#39;</span><span class="o">].</span><span class="n">to_i</span><span class="o">.</span><span class="n">nonzero?</span> <span class="o">||</span> <span class="mi">300</span>

    <span class="k">if</span> <span class="n">start_server</span>
      <span class="nb">puts</span> <span class="s2">&quot;Starting Solr server...&quot;</span>
      <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">&quot;solr:start&quot;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="k">end</span>

    <span class="c1"># Disable solr_optimize</span>
    <span class="k">module</span> <span class="nn">ActsAsSolr::CommonMethods</span>
      <span class="k">def</span> <span class="nf">blank</span><span class="p">()</span> <span class="k">end</span>
      <span class="n">alias_method</span> <span class="ss">:deferred_solr_optimize</span><span class="p">,</span> <span class="ss">:solr_optimize</span>
      <span class="n">alias_method</span> <span class="ss">:solr_optimize</span><span class="p">,</span> <span class="ss">:blank</span>
    <span class="k">end</span>

    <span class="n">models</span> <span class="o">=</span> <span class="n">includes</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:rebuild_solr_index</span><span class="p">)</span> <span class="p">}</span>
    <span class="n">models</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">model</span><span class="o">|</span>

      <span class="k">if</span> <span class="n">clear_first</span>
        <span class="nb">puts</span> <span class="s2">&quot;Clearing index for </span><span class="si">#{</span><span class="n">model</span><span class="si">}</span><span class="s2">...&quot;</span>
        <span class="no">ActsAsSolr</span><span class="o">::</span><span class="no">Post</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="no">Solr</span><span class="o">::</span><span class="no">Request</span><span class="o">::</span><span class="no">Delete</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:query</span> <span class="o">=&gt;</span> <span class="s2">&quot;type_t:</span><span class="si">#{</span><span class="n">model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>
      <span class="k">end</span>

      <span class="nb">puts</span> <span class="s2">&quot;Rebuilding index for </span><span class="si">#{</span><span class="n">model</span><span class="si">}</span><span class="s2">...&quot;</span>
      <span class="n">model</span><span class="o">.</span><span class="n">rebuild_solr_index</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>

    <span class="k">end</span>

    <span class="k">if</span> <span class="n">models</span><span class="o">.</span><span class="n">empty?</span>
      <span class="nb">puts</span> <span class="s2">&quot;There were no models to reindex.&quot;</span>
    <span class="k">elsif</span> <span class="n">optimize</span>
      <span class="nb">puts</span> <span class="s2">&quot;Optimizing...&quot;</span>
      <span class="n">models</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">deferred_solr_optimize</span>
    <span class="k">end</span>

    <span class="k">if</span> <span class="n">start_server</span>
      <span class="nb">puts</span> <span class="s2">&quot;Shutting down Solr server...&quot;</span>
      <span class="no">Rake</span><span class="o">::</span><span class="no">Task</span><span class="o">[</span><span class="s2">&quot;solr:stop&quot;</span><span class="o">].</span><span class="n">invoke</span>
    <span class="k">end</span>

  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">env_array_to_constants</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="n">env</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>
    <span class="n">env</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sr">/\s*,\s*/</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">m</span><span class="o">.</span><span class="n">singularize</span><span class="o">.</span><span class="n">camelize</span><span class="o">.</span><span class="n">constantize</span> <span class="p">}</span><span class="o">.</span><span class="n">uniq</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">env_to_bool</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
    <span class="n">env</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="n">env</span><span class="o">]</span> <span class="o">||</span> <span class="s1">&#39;&#39;</span>
    <span class="k">case</span> <span class="n">env</span>
      <span class="k">when</span> <span class="sr">/^true$/i</span><span class="p">:</span> <span class="kp">true</span>
      <span class="k">when</span> <span class="sr">/^false$/i</span><span class="p">:</span> <span class="kp">false</span>
      <span class="k">else</span> <span class="n">default</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span>
</pre>
</div>
