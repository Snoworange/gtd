<div class="highlight"><pre><span class="nb">require</span> <span class="s2">&quot;Time&quot;</span>
<span class="n">log_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">/Library/Application Support/Adium 2.0/Users/Default/Logs&quot;</span><span class="p">;</span>
<span class="n">date</span> <span class="o">=</span> <span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d&quot;</span><span class="p">);</span>

<span class="no">ARGV</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">friend</span><span class="o">|</span>  <span class="c1"># Get today&#39;s logs for contact</span>
  <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">log_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">friend</span><span class="si">}</span><span class="s2">/*(</span><span class="si">#{</span><span class="n">date</span><span class="si">}</span><span class="s2">).html&quot;</span><span class="o">].</span><span class="n">first</span>
<span class="k">end</span><span class="o">.</span><span class="n">compact</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>  <span class="c1"># Scan last message from each log for URLs</span>
  <span class="n">last_message</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">last</span>
  <span class="k">next</span> <span class="k">if</span> <span class="n">last_message</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">/^&lt;div class=&quot;send&quot;/</span><span class="p">)</span>  <span class="c1"># Nevermind outgoing messages</span>
  <span class="n">timestamp</span> <span class="o">=</span> <span class="n">last_message</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sr">%r{&lt;span class=&quot;timestamp&quot;&gt;(.*?)&lt;/span&gt;}</span><span class="p">)</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
  <span class="k">next</span> <span class="k">if</span> <span class="p">(</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">to_i</span> <span class="o">-</span> <span class="no">Time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span>  <span class="c1"># Nevermind old messages</span>
  <span class="n">urls</span> <span class="o">=</span> <span class="n">last_message</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/&lt;a href=&quot;(.+?)&quot;/i</span><span class="p">)</span>
  <span class="k">next</span> <span class="k">if</span> <span class="n">urls</span><span class="o">.</span><span class="n">empty?</span>
  <span class="n">urls</span> <span class="o">=</span> <span class="n">urls</span><span class="o">.</span><span class="n">flatten</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">url</span><span class="o">|</span> <span class="s1">&#39;&quot;&#39;</span> <span class="o">+</span> <span class="n">url</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;\&quot;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">}</span>  <span class="c1"># Avoid injections</span>
  <span class="c1"># Detach process, or incoming message will be delayed</span>
  <span class="sb">`{</span>
<span class="sb">  osascript -e &#39;say &quot;incoming URL</span><span class="si">#{</span><span class="s1">&#39;s&#39;</span> <span class="k">if</span> <span class="n">urls</span><span class="o">.</span><span class="n">size</span><span class="o">&gt;</span><span class="mi">1</span><span class="si">}</span><span class="sb">&quot;&#39;</span>
<span class="sb">  sleep 2</span>
<span class="sb">  open </span><span class="si">#{</span><span class="n">urls</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="si">}</span><span class="sb"></span>
<span class="sb">  } &amp;&gt;/dev/null &amp;`</span>
<span class="k">end</span>
</pre>
</div>
